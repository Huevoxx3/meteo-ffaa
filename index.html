<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MET - FFAA - ALA23</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 0;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1em;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }

    .corner-img {
      width: 60px;
      height: auto;
    }

    .title-block {
      flex: 1;
      text-align: center;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.5em;
    }

    .title-block .utc {
      margin-top: 0.5em;
      font-size: 0.9em;
    }

    /* === BOTONES PRINCIPALES === */
    .main-buttons {
      display: flex;
      justify-content: center;
      gap: 1em;
      flex-wrap: wrap;
      margin: 1em 0;
    }

    .main-button {
      display: block;
      padding: 0.7em 1.5em;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 8px;
      text-align: center;
      font-size: 1em;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }

    .main-button:hover {
      background-color: #005fa3;
    }

    /* === ÁREA PRINCIPAL === */
    .main-content {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin: 1em;
    }

    .windy-left, .windy-right {
      flex: 1;
      min-width: 300px;
      max-width: 48%;
      margin: 1em;
    }

    iframe {
      width: 100%;
      height: 400px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border: none;
    }

    /* === BOTONES DE AERÓDROMOS === */
    .aerodromo-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 1em;
      justify-content: center;
    }

    .aero-btn {
      background-color: white;
      border: 1px solid #0077cc;
      color: #0077cc;
      border-radius: 6px;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .aero-btn.active {
      background-color: #0077cc;
      color: white;
    }

    /* === TARJETAS METAR/TAF === */
    #aerodromos-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }

    .aerodromo {
      background: white;
      border-radius: 8px;
      padding: 1em;
      margin: 1em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      flex: 1 1 100%;
      max-width: 100%;
    }

    .metar, .taf {
      margin-top: 0.5em;
      font-family: monospace;
      white-space: pre-wrap;
    }

    .condicion {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.8em;
      color: white;
      margin-left: 8px;
      cursor: help;
    }

    footer.disclaimer-footer {
      text-align: center;
      font-size: 0.75em;
      color: rgba(0, 0, 0, 0.55);
      margin-top: 3em;
      padding: 1em 0;
    }

    footer.disclaimer-footer p {
      margin: 0 auto;
      max-width: 600px;
      line-height: 1.6em;
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        text-align: center;
      }
      .title-block {
        margin: 0.5em 0;
      }
      .main-content {
        flex-direction: column;
        align-items: center;
      }
      .windy-left, .windy-right {
        max-width: 100%;
      }
      .aerodromo {
        max-width: 95%;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="https://github.com/Huevoxx3/sectores-kml/raw/main/231%20ESCUDO.jpg" alt="Logo Izquierdo" class="corner-img" />
    <div class="title-block">
      <h1>Información Meteorológica - FFAA</h1>
      <div id="utc-time" class="utc"></div>
    </div>
    <img src="https://github.com/Huevoxx3/sectores-kml/raw/main/232SQN.jpg" alt="Logo Derecho" class="corner-img" />
  </header>

  <div class="main-buttons">
    <a class="main-button" href="https://www.windy.com/?38.878,-6.9707,7" target="_blank">Ver en Windy</a>
    <a class="main-button" href="#" target="_blank">Abrir el BOD</a>
    <a class="main-button" href="https://github.com/Huevoxx3/meteo-ffaa/gramet.html" target="_blank">Formulario GRAMET</a>
  </div>

  <div class="main-content">
    <div class="windy-left">
      <iframe src="https://embed.windy.com/embed2.html?lat=38.878&lon=-6.9707&zoom=7&level=surface&overlay=radar"></iframe>
    </div>
    <div class="windy-right">
      <iframe src="https://embed.windy.com/embed2.html?lat=38.878&lon=-6.9707&zoom=8&detail=true"></iframe>
    </div>
  </div>

  <div class="aerodromo-buttons" id="aero-buttons-container"></div>
  <div id="aerodromos-container"></div>

  <footer class="disclaimer-footer">
    <p>
      Esta página se utiliza con fines académicos y de entrenamiento.<br>
      No procesa información meteorológica ni garantiza su actualización en tiempo real.<br>
      Los datos son recopilados de fuentes públicas como AVWX y Ogimet.
    </p>
  </footer>

<script>
  const API_KEY = "SYybZksTKoBvX_zwxGfEV1PYOtstVhCVgysShs-_Vg4";

  const alwaysVisible = ["LEBZ", "LPBJ", "LEMO"];
  const icaoNames = {
    LEBZ: "BADAJOZ", LPBJ: "BEJA", LEMO: "MORÓN",
    LEAB: "ALBACETE", LERT: "ROTA", LEGT: "GETAFE",
    LETO: "TORREJÓN", LEMG: "MÁLAGA", LELC: "SAN JAVIER",
    LESA: "SALAMANCA", LEVD: "VALLADOLID", LEZG: "ZARAGOZA"
  };

  const container = document.getElementById("aerodromos-container");
  const buttonContainer = document.getElementById("aero-buttons-container");

  // === Función para determinar condición (Windy-style) ===
  function determinarCondicionVuelo(metarRaw) {
    if (!metarRaw || metarRaw.toUpperCase().includes("ERROR")) {
      return { cat: "N/A", color: "#777", tooltip: "Sin información disponible" };
    }
    const raw = metarRaw.toUpperCase();
    if (/\bCAVOK\b/.test(raw)) return { cat: "VFR", color: "#2ecc71", tooltip: "CAVOK — Condiciones óptimas" };

    // VISIBILIDAD
    let visibility = 9999;
    const visMatches = [...raw.matchAll(/\b(\d{4})(?=\s|[A-Z])/g)].map(v => parseInt(v[1]));
    if (visMatches.length > 0) visibility = Math.min(...visMatches);

    // TECHO
    let ceiling = 99999;
    const cloudMatches = [...raw.matchAll(/\b(BKN|OVC|VV)(\d{3})\b/g)].map(c => parseInt(c[2]) * 100);
    if (cloudMatches.length > 0) ceiling = Math.min(...cloudMatches);

    // Categorías
    let visCat = "VFR";
    if (visibility < 1500) visCat = "LIFR";
    else if (visibility < 3000) visCat = "IFR";
    else if (visibility < 5000) visCat = "MVFR";

    let ceilCat = "VFR";
    if (ceiling < 500) ceilCat = "LIFR";
    else if (ceiling < 1000) ceilCat = "IFR";
    else if (ceiling < 3000) ceilCat = "MVFR";

    // Peor condición
    const order = ["LIFR", "IFR", "MVFR", "VFR"];
    const worstIdx = Math.min(order.indexOf(visCat), order.indexOf(ceilCat));
    const cat = order[worstIdx];

    const colorMap = { VFR: "#2ecc71", MVFR: "#3498db", IFR: "#e74c3c", LIFR: "#9b59b6", "N/A": "#777" };
    const tooltipMap = {
      VFR: "VFR — Condiciones visuales favorables",
      MVFR: "MVFR — Vuelo visual marginal",
      IFR: "IFR — Vuelo por instrumentos",
      LIFR: "LIFR — Condiciones muy limitadas",
      "N/A": "Sin información suficiente"
    };

    return { cat, color: colorMap[cat] || "#777", tooltip: tooltipMap[cat] || "" };
  }

  // === Obtener datos METAR/TAF ===
  async function fetchData(icao) {
    try {
      const [metarRes, tafRes] = await Promise.all([
        fetch(`https://avwx.rest/api/metar/${icao}?token=${API_KEY}`),
        fetch(`https://avwx.rest/api/taf/${icao}?token=${API_KEY}`)
      ]);
      const metar = await metarRes.json();
      const taf = await tafRes.json();
      return {
        metar: metar?.raw || "No METAR disponible",
        taf: taf?.raw || "No TAF disponible"
      };
    } catch {
      return { metar: "Error al obtener METAR", taf: "Error al obtener TAF" };
    }
  }

  // === Crear botones dinámicos ===
  async function crearBotones() {
    for (const icao of Object.keys(icaoNames)) {
      if (alwaysVisible.includes(icao)) continue;

      const data = await fetchData(icao);
      const { color, tooltip } = determinarCondicionVuelo(data.metar);

      const btn = document.createElement("button");
      btn.className = "aero-btn";
      btn.title = tooltip;
      btn.innerHTML = `
        <span class="color-dot" style="background:${color};"></span>
        ${icaoNames[icao]} (${icao})
      `;
      btn.onclick = () => toggleAerodromo(icao, btn);
      buttonContainer.appendChild(btn);
    }
  }

  // === Mostrar / ocultar tarjeta ===
  async function toggleAerodromo(icao, button) {
    const existingCard = document.getElementById(`card-${icao}`);
    if (existingCard) {
      existingCard.remove();
      button.classList.remove("active");
      return;
    }

    button.classList.add("active");
    const data = await fetchData(icao);
    const { cat, color, tooltip } = determinarCondicionVuelo(data.metar);

    const card = document.createElement("div");
    card.className = "aerodromo";
    card.id = `card-${icao}`;
    const name = icaoNames[icao] || icao;
    card.innerHTML = `
      <h3>${name} (${icao})
        <span class="condicion" style="background-color:${color}" title="${tooltip}">${cat}</span>
      </h3>
      <div class="metar"><strong>METAR:</strong><br>${data.metar}</div>
      <div class="taf"><strong>TAF:</strong><br>${data.taf}</div>
    `;
    container.appendChild(card);
  }

  // === Cargar aeródromos fijos ===
  async function loadAlwaysVisible() {
    for (const icao of alwaysVisible) {
      const data = await fetchData(icao);
      const { cat, color, tooltip } = determinarCondicionVuelo(data.metar);
      const card = document.createElement("div");
      card.className = "aerodromo";
      card.id = `card-${icao}`;
      const name = icaoNames[icao] || icao;
      card.innerHTML = `
        <h3>${name} (${icao})
          <span class="condicion" style="background-color:${color}" title="${tooltip}">${cat}</span>
        </h3>
        <div class="metar"><strong>METAR:</strong><br>${data.metar}</div>
        <div class="taf"><strong>TAF:</strong><br>${data.taf}</div>
      `;
      container.appendChild(card);
    }
  }

  // === Reloj UTC ===
  function updateUtcTime() {
    const now = new Date();
    const utcStr = now.toISOString().slice(0, 19).replace("T", " ") + " UTC";
    document.getElementById("utc-time").textContent = utcStr;
  }
  setInterval(updateUtcTime, 1000);
  updateUtcTime();

  // === Inicialización ===
  window.onload = async () => {
    await loadAlwaysVisible();
    await crearBotones();
  };
</script>

<style>
  .color-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
  }
</style>


</body>
</html>




